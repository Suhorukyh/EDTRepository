
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//УчетГазаСервер.НастроитьФормуСписка(ЭтаФорма, Отказ);
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСписок(Команда)
	УправлениеПользователямиСервер.ОбновитьСправочникПользователей();
	Элементы.Список.Обновить();
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьРоли(Команда)
	ПроверитьРолиНаСервере();
КонецПроцедуры
&НаСервере
Процедура ПроверитьРолиНаСервере()
	перем Выборка, ПользовательИБ, Роль, ПроверитьПользователя;
	
	Выборка = Справочники.Пользователи.Выбрать();
	пока Выборка.Следующий() цикл
		если Выборка.ЭтоГруппа или Выборка.Недействителен тогда
			продолжить;
		конецесли;
		
		УстановитьПривилегированныйРежим(истина);
		ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(Выборка.ИдентификаторПользователяИБ);
		УстановитьПривилегированныйРежим(ложь);
		
		ПроверитьПользователя = ложь;
		
		для каждого Роль из ПользовательИБ.Роли цикл
			если ЗначениеЗаполнено(Роль.Комментарий) тогда
				ПроверитьПользователя = истина;
				прервать;
			конецесли;
		конеццикла;
		
		если ПроверитьПользователя тогда
			Сообщить(Выборка.Наименование);
		конецесли;
	конеццикла;
КонецПроцедуры

&НаКлиенте
Процедура ВключитьИнтерфейсТакси(Команда)
	если не УправлениеПользователямиПовтИсп.РольДоступнаАдминистраторСистемы() тогда
		возврат;
	конецесли;
	если Вопрос("Включить интерфейс ""Такси"" для всех пользователей?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да тогда
		НастроитьИнтерфейсНаСервере(ВариантИнтерфейсаКлиентскогоПриложения.Такси, Вопрос("Установить интерфейс ""Такси"" как обязательный?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да);
	конецесли;
КонецПроцедуры
&НаКлиенте
Процедура ОтключитьИнтерфейсТакси(Команда)
	если не УправлениеПользователямиПовтИсп.РольДоступнаАдминистраторСистемы() тогда
		возврат;
	конецесли;
	если Вопрос("Отключить интерфейс ""Такси"" для всех пользователей?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да тогда
		НастроитьИнтерфейсНаСервере(ВариантИнтерфейсаКлиентскогоПриложения.Версия8_2, ложь);
	конецесли;
КонецПроцедуры

&НаСервере
Процедура НастроитьИнтерфейсНаСервере(ВариантИнтерфейса, ИспользоватьИнтерфейсТакси)
	перем Запрос, Выборка;
	перем Пользователь, ПользовательИБ;
	перем Изменено;
	
	Запрос = новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Ссылка,
	|	Наименование,
	|	ИдентификаторПользователяИБ,
	|	ИспользоватьИнтерфейсТакси
	|ИЗ
	|	Справочник.Пользователи
	|ГДЕ
	|	НЕ ЭтоГруппа
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	пока Выборка.Следующий() цикл
		Изменено = ложь;
		
		если Выборка.ИспользоватьИнтерфейсТакси <> ИспользоватьИнтерфейсТакси тогда
			Пользователь = Выборка.Ссылка.ПолучитьОбъект();
			Пользователь.ИспользоватьИнтерфейсТакси = ИспользоватьИнтерфейсТакси;
			Пользователь.ОбменДанными.Загрузка = истина;
			Пользователь.Записать();
			
			Изменено = истина;
		конецесли;
		
		УстановитьПривилегированныйРежим(истина);
		ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(Выборка.ИдентификаторПользователяИБ);
		УстановитьПривилегированныйРежим(ложь);
		
		если ПользовательИБ <> неопределено тогда
			если УправлениеПользователямиСервер.НастроитьИнтерфейсПриложения(ПользовательИБ.Имя, ВариантИнтерфейса) тогда
				Изменено = истина;
			конецесли;
		конецесли;
		
		если Изменено тогда
			Сообщить(Выборка.Наименование);
		конецесли;
	конеццикла;
КонецПроцедуры
